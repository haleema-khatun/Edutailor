{% extends "base.html" %}
{% block content %}

<div class="fade-in">
    <div class="glass-card-static chat-container">

        <!-- Chat Header -->
        <div class="chat-header">
            <h4>
                <span class="status-dot"></span>
                AI Mock Interview
            </h4>
            <div class="d-flex gap-2">
                <a href="/end_interview" class="btn-outline-glass" style="font-size: 0.82rem; padding: 0.4rem 1rem;">
                    <i class="fas fa-stop-circle"></i> End Interview
                </a>
            </div>
        </div>

        <!-- Chat Messages -->
        <div class="chat-messages" id="chatbox">
            {% if not chat %}
            <div class="text-center" style="margin: auto; color: var(--text-muted);">
                <i class="fas fa-robot" style="font-size: 3rem; margin-bottom: 1rem; color: var(--accent-purple);"></i>
                <p>Your AI interviewer is ready. Start the conversation!</p>
            </div>
            {% endif %}

            {% for msg in chat %}
            <div class="message {% if msg.role == 'interviewer' %}message-ai{% else %}message-user{% endif %}">
                <div class="message-role">
                    {% if msg.role == 'interviewer' %}
                    <i class="fas fa-robot"></i> AI Interviewer
                    {% else %}
                    <i class="fas fa-user"></i> You
                    {% endif %}
                </div>
                <div class="message-bubble">{{ msg.content }}</div>

                {% if msg.analysis %}
                <div class="analysis-panel">
                    <span
                        class="score-badge {% if msg.analysis.score >= 70 %}score-high{% elif msg.analysis.score >= 40 %}score-medium{% else %}score-low{% endif %}">
                        <i class="fas fa-star"></i> Score: {{ msg.analysis.score }}/100
                    </span>

                    <div style="margin-top: 0.5rem;">
                        <div class="progress-bar-custom">
                            <div class="progress-fill" style="width: {{ msg.analysis.confidence }}%;"></div>
                        </div>
                        <div class="progress-label">
                            <span>Confidence</span>
                            <span>{{ msg.analysis.confidence }}%</span>
                        </div>
                    </div>

                    {% if msg.analysis.feedback %}
                    <div style="margin-top: 0.8rem;">
                        <small style="color: var(--text-muted); font-weight: 600;">
                            <i class="fas fa-lightbulb" style="color: var(--accent-orange);"></i> Feedback
                        </small>
                        <ul
                            style="margin: 0.3rem 0 0; padding-left: 1.2rem; font-size: 0.85rem; color: var(--text-secondary);">
                            {% for f in msg.analysis.feedback %}
                            <li>{{ f }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Input Area -->
        <div class="chat-input-area">
            <form method="POST" class="chat-input-group" id="chatForm">
                <input type="text" id="message" name="message" class="form-control form-control-glass chat-input"
                    placeholder="Type your answer here..." required autocomplete="off">

                <button type="button" onclick="startListening()" class="mic-btn" id="micBtn" title="Voice Input">
                    <i class="fas fa-microphone"></i>
                </button>

                <button type="submit" class="send-btn" title="Send">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>

    </div>
</div>

<script>
    // Auto-scroll to bottom
    function scrollToBottom() {
        const chatbox = document.getElementById('chatbox');
        chatbox.scrollTop = chatbox.scrollHeight;
    }
    window.addEventListener('load', scrollToBottom);

    // Voice input
    function startListening() {
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        const micBtn = document.getElementById('micBtn');

        recognition.lang = "en-US";
        recognition.interimResults = false;

        micBtn.classList.add('recording');

        recognition.start();

        recognition.onresult = function (event) {
            document.getElementById("message").value = event.results[0][0].transcript;
            micBtn.classList.remove('recording');
        };

        recognition.onerror = function () {
            micBtn.classList.remove('recording');
        };

        recognition.onend = function () {
            micBtn.classList.remove('recording');
        };
    }

    // Speak AI questions
    function speak(text) {
        const speech = new SpeechSynthesisUtterance();
        speech.text = text;
        speech.lang = "en-US";
        speech.rate = 1;
        window.speechSynthesis.speak(speech);
    }

    // Speak last AI message on load
    window.addEventListener('load', function () {
        const messages = document.querySelectorAll('.message-ai .message-bubble');
        if (messages.length > 0) {
            const lastMsg = messages[messages.length - 1].textContent.trim();
            if (lastMsg) speak(lastMsg);
        }
    });
</script>

{% endblock %}